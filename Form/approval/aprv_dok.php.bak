<?php

$sect= $_SESSION["area"]; 

$pic=$_SESSION["nama"];

$akses=$_SESSION["akses"];

$user=$_SESSION["user"];



$pch_sec=explode("-",$sect);

$whr="and sect='-'";

$perinow=date("Ym");

$lok=$_SESSION['lokasi'];

// $adm=strpos($akses,'ADM_FA');

$admin_FA=strpos($akses,'_FA');

$kd_akses=explode(",",$akses);

if(in_array('ADM_FA',$kd_akses)){

	$adm1="admin";

}else{

	$adm1="user";

}



$optsect='';

 if($_GET['prv']=='verified' and $adm1== 'admin' ){

 	$optsect='<option selected="selected" value="">--Pilih Section--</option>';

$cr_sect="select DISTINCT sect from bps_approve where sect not like '%ALL%' and no_aprv<=3 order by sect asc";

	$tb_sect=odbc_exec($koneksi_lp,$cr_sect);

	while(odbc_fetch_array($tb_sect)){ 

	$plh_sect=odbc_result($tb_sect,"sect");

	$optsect .='<option value="'.$plh_sect.'">'.$plh_sect.'</option>';

	}

}else{

	$optsect ='<option value="'.$sect.'">'.$sect.'</option>';

}

$optdok='<option selected="selected" value="">--Pilih Jenis Dok--</option>';

//$cr_dok="select DISTINCT jns_doc from bps_approve where sect ='$sect' and no_aprv<=3 ";

$cr_dok="select DISTINCT jns_doc from bps_approve where sect ='$sect' ";

	$tb_dok=odbc_exec($koneksi_lp,$cr_dok);

	while(odbc_fetch_array($tb_dok)){ 

	$plh_dok=odbc_result($tb_dok,"jns_doc");

	$optdok .="<option value='".$plh_dok."'>".$plh_dok."</option>";

	}

?>

<section class="content">

	<div class="container-fluid">

		<div class="block-header">

			<h2>APPROVE <?php echo strtoupper($sect); ?></h2>

		</div>

		<div class="row clearfix">

			<div class="card">				

				<div class="header">

					<h2>Record Document Approve<small>Lihat data Approve <?php // echo $_GET['prv'] ; ?></small></h2>

				</div>

				<form role="form"  name="frm" id="frm" method="post" action="" enctype="multipart/form-data">



					

						<!-- <div class="col-sm-4">

							<div class="form-group">

								<label>Range Tanggal</label>

								<div class="form-line">

									<input type="text"  class="form-control" id="rg_tgl" name="rg_tgl" placeholder="Detail Pencarian" required>

								</div>		

							</div>

						</div> -->

							<div class="col-sm-4">

							<div class="form-group ">

								<label>Jenis Dokumen</label>

								<div class="form-line">

									<select class="selectpicker"  style="width: 100%;"  name="jnsdok" id="jnsdok" >

										<?=$optdok;?>

									</select>

								</div>		

							</div>

						</div>

						<div class="col-sm-4">

							<div class="form-group">

								<label>Section</label>

								<div class="form-line">

									<select class="selectpicker"  style="width: 100%;"  name="sectu" id="sectu" >

										<?=$optsect;?>

									</select>

								</div>		

							</div>

						</div>

					

					<div class="col-sm-4">

						<div class="form-group">

							<label>Status</label>

							<div class="input-group">

								<div class="form-line">

									<select class="selectpicker" style="width: 100%;"  name="cr_status" id="cr_status">

										<option value="">--Pilih Status--</option>

										<option value='CHECKED'>SUDAH CHECK</option>

										<option value='BLMCHECKED'>BELUM CHECK</option>

									</select>

								</div>

								<span class="input-group-addon">

									<button type="submit" name="cr_dt" id="cr_dt" class="btn bg-purple waves-effect"><i class="material-icons">search</i> </button>

								</span>

							</div>

						</div>

					</div>

					<div class="row clearfix">

						<div class="col-sm-12">

							<div class="body">

								<div class="table-responsive">

									<table id="example" class="table table-bordered table-striped table-hover dataTable js-exportable tabel2">

										<thead>

											<tr>

												<th>No</th>

												<th>Jenis Doc.</th>

												<th>No Doc.</th>

												<th>Status</th>

												<th>Action</th>

											</tr>

										</thead>

									</form>

									<tbody>

										<?php

										//if(isset($_POST['cr_dt']) || isset($_REQUEST['jnsdok'])){

											if(isset($_POST['cr_dt'])){

											$status=$_POST['cr_status'];

											$sectu=$_POST['sectu'] ;

												//$crsect=" and no_doc like '%$sectu%'";

												

											$jnsdoc=$_POST['jnsdok'];

											

											

											/*

											if(isset($_REQUEST['jnsdok'])){

												$status=$_REQUEST['cr_status'];

												$sectu=$_REQUEST['sectu'] ;

												$jnsdoc=$_REQUEST['jnsdok'];

											}

											*/

											$crsect=" and sect ='$sectu'";

											

											if($status=='CHECKED'){

												//$qry_crtrm="select distinct DATEADD(month,-2,max(start_term))[awal] from bps_setTerm where start_term<=getdate() and finish_term>=getdate()";
												
												$qry_crtrm="select distinct DATEADD(month,-2,max(start_term))[awal] from bps_setTerm where start_term<=getdate() and finish_term>=getdate()";

												$whrtgl="and tgl_prepaire>=($qry_crtrm)";												

											}else{

												$whrtgl="";

											}

											/*$rg_tg=$_POST['rg_tgl'];

												$rg_tgl=explode("-",$rg_tg);

												$rg_tgl0=date("Y-m-d",strtotime($rg_tgl[0]));

												$rg_tgl1=date("Y-m-d",strtotime($rg_tgl[1]));

												$whrtgl=" and tgl_prepaire BETWEEN '".$rg_tgl0." 00:00:00.000' AND '".$rg_tgl1." 23:59:59.999'";*/	

												

												switch ($status) {

													case 'CHECKED':

														if($_GET['prv']=='verified'){

															$whrfil=" and status='FINISH'";

														}else{

															$whrfil=" and status in ('Close','FINISH')";

														}

														break;

													case 'BLMCHECKED':

														if($_GET['prv']=='verified'){

															$whrfil=" and (status='Close' or status is null )";

														}else{

															$whrfil=" and status is null ";

														}

														break;

													default:

														$whrfil="";

														break;

												}									



											

												$date_valid = date("Y-m-d", strtotime(date("Y-m-d") . " -3 months"));

												



											if(isset($_GET['prv'])){

												/*jns_doc in ('ADD','PR','kontrak')*/

												switch ($_GET['prv']){

													case 'section':

													$whr=" sect='$sect'";

													$whrtgl ="AND tgl_prepaire = '2024-05-30 00:00:00'";

													$sq_acc="SELECT * from bps_approve where jns_doc='$jnsdoc' and  pic_plan='$pic' AND tgl_prepaire >= '$date_valid' and $whr $whrfil order by no_doc DESC";

													break;



													case 'mgr':



													$whr="pic_plan='$pic' and no_doc in (select no_doc from bps_approve where status IN ('close','FINISH') and no_aprv<(select min(no_aprv) from bps_approve where pic_plan='$pic')) and no_aprv<10";

													$whrtgl ="AND tgl_prepaire = '2024-05-30 00:00:00'";

													//$sq_acc="SELECT * from bps_approve where jns_doc='$jnsdoc' AND tgl_prepaire >= '$date_valid' AND $whr $whrfil $whrtgl  order by no_doc DESC";
													
														$sq_acc="SELECT * from bps_approve where jns_doc='$jnsdoc' AND tgl_prepaire >= '$date_valid' AND $whr $whrfil order by no_doc DESC";

													break;



													case 'verified':

													$checkadd="";

													if( $adm1!= 'admin' ){

														$section="$sectu";

														$crapp="";//" and  pic_plan='$pic' ";

														$checkadd=" and (NOT EXISTS (select top 1 a.doc_no from bps_budget_add a inner join bps_pr b on a.no_ctrl=b.no_ctrl and a.periode=b.periode where b.pr_no=c.no_doc) OR exists (select top 1 a.doc_no from bps_budget_add a inner join bps_pr b on a.no_ctrl=b.no_ctrl and a.periode=b.periode inner join bps_approve d on d.no_doc=a.doc_no where b.pr_no=c.no_doc and d.pic_act IS NOT NULL))";

														

													}else{

														$section="$sect";

														$crapp="";

														$checkadd="";

													}

													

													/*$whr=" and no_doc in (select no_doc from bps_approve where sect='$sectu'

													and (status='close' or status='FINISH'))";*/

														$whr="";

														$sq_acc="SELECT DISTINCT jns_doc,status,no_doc,max(no_aprv) as no_aprv,

														max(tgl_prepaire) as tgl_prepaire

														from bps_approve c where jns_doc='$jnsdoc' AND tgl_prepaire >= '$date_valid' $crapp $whrtgl $crsect $whrfil $whr $checkadd

														group by jns_doc,status,no_doc

														order by jns_doc,no_doc DESC";

													break;



													default :

														$whr="status is null and sect='SAMI-ALL' and pic_plan='$pic'";

														$sq_acc="SELECT * from bps_approve where jns_doc='$jnsdoc' AND tgl_prepaire >= '$date_valid' and $whr $whrfil $whrtgl order by no_doc DESC";

													break;

												}

											}



											$tb_acc=odbc_exec($koneksi_lp,$sq_acc);

											echo $sq_acc;

											$row=0;

											while($baris1=odbc_fetch_array($tb_acc)){ 

												$row++;

												$jns_doc=odbc_result($tb_acc,"jns_doc");

												$stts=odbc_result($tb_acc,"status");

												$no_doc=odbc_result($tb_acc,"no_doc");

												$no_aprv=odbc_result($tb_acc,"no_aprv");

												?>	

												<tr  onclick="javascript:pilih(this);" >

													<td><?php echo $row; ?></td>

													<td><?php echo $jns_doc; ?></td>

													<td><?php echo $no_doc; ?></td>

													<td><?php echo $stts; ?></td>

													<td>

														

														<?php

														

														switch ($jns_doc) {

															case 'PR':

																$phpaprv="form/pr/aprv_PR.php";

																

																break;

																case 'ADD':

																$phpaprv="form/pr/aprv_ADD.php";

																break;

															

															default:

																$phpaprv="select/aprv_".$jns_doc.".php";

																break;

														}

														

														if($_GET['prv']=='mgr' and $jns_doc=="PR"){

														?>

														

														<a href="<?php echo $phpaprv;?>?nomor=<?php echo $row;?>&nodoc=<?php echo $no_doc;?>&lok=<?php echo $lok ;?>&jnsdok=<?php echo $jns_doc;?>&stts=<?php echo $status;?>&prv=<?= $_GET['prv'];?>&sectu=<?php echo $sectu;?>"><button type="button" class="btn bg-green waves-effect"><i class="material-icons">visibility</i>

														</button></a>

														

														<?php

														}else{

														?>

														<button type="button" class="btn bg-green waves-effect" onclick="open_child('<?php echo $phpaprv;?>?nomor=<?php echo $row;?>&nodoc=<?php echo $no_doc;?>&lok=<?php echo $lok ;?>&jnsdok=<?php echo $jns_doc;?>&stts=<?php echo $status;?>&prv=<?= $_GET['prv'];?>','Lihat Detail <?php echo $no_doc;?>','800','500'); return false;"><i class="material-icons">visibility</i>

														</button>

														<?php 

														}

//}

														?>

													</td>

												</tr>

												<?php 

											}

										}

										?>	

									</tbody>

									<tfoot>

										<tr>	

										</tr>

									</tfoot>

								</table>

							</div>

						</div>

					</div>	

				</div>

			</div>	

		</div>

	</div>           

</div>

</section>

<?php include 'form/approval/aprvdok_js.php'; ?>